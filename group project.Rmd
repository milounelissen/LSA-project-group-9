---
title: "group project"
output: html_document
date: "2025-11-13"
---

// rerun block below //
```{r}
library(tidyverse)
library(data.table)
library(ggplot2)
library(dplyr)
library(survival) 
library(survminer)
df_expressie_matrix <- fread("GSE96058_expression_matrix.tsv")
meta <- read.delim("GSE96058_metadata.txt", header = TRUE)
meta <- meta %>% 
  mutate(er_status = factor(ifelse(er.status.ch1 == 1, "Positive",
                                   ifelse(er.status.ch1 == 0, "Negative", NA))),
         pgr_status = factor(ifelse(pgr.status.ch1 == 1, "Positive", 
                                    ifelse(pgr.status.ch1 == 0, "Negative", NA))),
         her2_status = factor(ifelse(her2.status.ch1 == 1, "Positive", 
                                     ifelse(her2.status.ch1 == 0, "Negative", NA))),
         ki67_status = factor(ifelse(ki67.status.ch1 == 1, "High", 
                                     ifelse(ki67.status.ch1 == 0, "Low", NA))),
         chemo = factor(ifelse(chemo.treated.ch1 == 1, "Yes", 
                               ifelse(chemo.treated.ch1 == 0, "No", NA))), 
         endocrine = factor(ifelse(endocrine.treated.ch1 == 1, "Yes", 
                                   ifelse(endocrine.treated.ch1 == 0, "No", NA))),
         nhg_ord = factor(nhg.ch1, levels = c("G1","G2","G3"), ordered = TRUE), 
         pam50 = factor(pam50.subtype.ch1))
meta_clean <- meta %>% drop_na(er.status.ch1, her2.status.ch1, tumor.size.ch1)
meta_clean$tumor_size_clean <- ifelse(meta_clean$tumor.size.ch1 == 0, NA, meta_clean$tumor.size.ch1)
numeric_vars <- c("age.at.diagnosis.ch1", "tumor_size_clean", "overall.survival.days.ch1")
meta_scaled <- meta
meta_scaled[numeric_vars] <- lapply(meta[numeric_vars], 
                                    function(x) {(x - mean(x, na.rm = TRUE)) / sd(x, na.rm = TRUE)})
```

# PART 1: DATA EXPLORATION

## loading the data
```{r}
library(data.table)
library(dplyr)
library(tidyverse)
library(tidyr)
library(ggpubr)

df <- fread("GSE96058_expression_matrix.tsv")
  #fread gebruikt alle processors itt gewone read ftie
meta <- read.delim("GSE96058_metadata.txt", header = TRUE)
```

## exploring the data 
```{r} 
# amount of samples (rows) and variables (columns)
dim(meta_data)

# show first few rows
head(meta_data)

# statistical summary (for numerics/factors)
summary(meta) 
```

## type of variables
```{r}
str(meta)         # Structure (types, columns)
```

## distribution

```{r}
library(ggplot2)
library(dplyr)
library(explore)
```

*distribution of age at diagnosis*
```{r}
summary(meta_data$age.at.diagnosis.ch1)
boxplot(meta_data$age.at.diagnosis.ch1, main="Age at diagnosis")
ggplot(meta_data, aes(age.at.diagnosis.ch1)) +
  geom_histogram(bins = 40, fill = "steelblue") +
  labs(title = "Age at diagnosis")

# log transformation of the age distribution:
ggplot(meta_data, aes(x = log(age.at.diagnosis.ch1))) +
  geom_histogram(bins = 40, fill = "steelblue", color = "black", alpha = 0.7) +
  labs(title = "Log-Transformed Age At Diagnosis",
       x = "log(Age At Diagnosis)", y = "Count")
```

*distribution of tumor size distribution*
```{r}
summary(meta_data$tumor.size.ch1)
boxplot(meta_data$tumor.size.ch1, main="Tumor Size")
ggplot(meta_data, aes(tumor.size.ch1)) + 
  geom_histogram(bins = 40, fill = "steelblue") + 
  labs(title = "Tumor Size Distribution")

# log transformation of the tumor size:
ggplot(meta_data, aes(x = log(tumor.size.ch1))) +
  geom_histogram(bins = 40, fill = "steelblue", color = "black", alpha = 0.7) +
  labs(title = "Log-Transformed Tumor Size Distribution",
       x = "log(Tumor Size)", y = "Count")
```

*distribution of overall survival*
```{r}
summary(meta_data$overall.survival.days.ch1)
boxplot(meta_data$overall.survival.days.ch1, main="Overall Survival (days)")
ggplot(meta_data, aes(overall.survival.days.ch1)) + 
  geom_histogram(bins = 40, fill = "steelblue") + 
  labs(title = "Overall Survival (days)")

ggplot(meta_data, aes(x = log(overall.survival.days.ch1))) +
  geom_histogram(bins = 40, fill = "steelblue", color = "black", alpha = 0.7) +
  labs(title = "Log-Transformed Overall Survival (days)",
       x = "log(Overall Survival (days))", y = "Count")
```

*distribution of PAM50*
```{r}
ggplot(meta_data, aes(pam50.subtype.ch1)) + 
  geom_bar(fill = "steelblue") + 
  labs(title = "PAM50 Subtype Distribution")
```

*distribution of ER status*
```{r}
# ER status distribution
ggplot(meta_data, aes(er.status.ch1)) + 
  geom_bar(fill = "orange") + 
  labs(title = "ER Status Distribution")
```

## outliers
outliers according to IQR method

*tumor size*
```{r}
qs <- quantile(meta$tumor_size_clean, c(.25, .75), na.rm = TRUE) 
iqr <- qs[2] - qs[1] 
lower <- qs[1] - 1.5 * iqr 
upper <- qs[2] + 1.5 * iqr
meta$tumor_outlier <- ifelse(meta$tumor_size_clean < lower | meta$tumor_size_clean > upper, TRUE, FALSE) 

#Plots
p1 <- ggplot(meta, aes(y = tumor_size_clean)) + 
  geom_boxplot() + 
  labs(title = "Tumor size (with outliers)")
p2 <- ggplot(meta, aes(x = tumor_size_clean)) + 
  geom_histogram(bins = 40) 
p3 <- ggplot(meta, aes(x = log1p(tumor_size_clean))) + 
  geom_histogram(bins = 40) 
p1 #boxplot
p2 #histogram
p3 #log-transformed histogra
```

*overall survival*
```{r}
qs <- quantile(meta$overall.survival.days.ch1, c(.25, .75), na.rm = TRUE)
iqr <- qs[2] - qs[1]
lower <- qs[1] - 1.5 * iqr
upper <- qs[2] + 1.5 * iqr
meta$outlier <- ifelse(meta$overall.survival.days.ch1 < lower | meta$overall.survival.days.ch1 > upper, TRUE, FALSE) #hier heeft chat gpt me geholpen weet ook niet wat dit exact is

#Plots
p1 <- ggplot(meta, aes(y = overall.survival.days.ch1)) + geom_boxplot() + labs(title = "Overall survival (with outliers)")
p2 <- ggplot(meta, aes(x = overall.survival.days.ch1)) + geom_histogram(bins = 40)
p3 <- ggplot(meta, aes(x = log1p(overall.survival.days.ch1))) + geom_histogram(bins = 40)
p1
p2
p3 # ziet er nog steeds niet normaal verdeeld uit -> dienen we nog iets met die outliers te doen? 
```

*age at diagnosis*
```{r}
meta$outlier <- meta$age.at.diagnosis.ch1 < lower | meta$age.at.diagnosis.ch1 > upper

p1 <- ggplot(meta, aes(y = age.at.diagnosis.ch1)) + 
  geom_boxplot() + 
  labs(title = "Age at Diagnosis (with outliers)")

# Histogram of original ages
p2 <- ggplot(meta, aes(x = age.at.diagnosis.ch1)) + 
  geom_histogram(bins = 40) + 
  labs(title = "Histogram of Age at Diagnosis")

# Histogram of log-transformed ages
p3 <- ggplot(meta, aes(x = log1p(age.at.diagnosis.ch1))) + 
  geom_histogram(bins = 40) + 
  labs(title = "Log-Transformed Age at Diagnosis")

p1
p2
p3
```


## missing values
```{r}
any(is.na(df))
any(is.na(meta))

colSums(is.na(meta))     # Missing values per column
sum(is.na(meta))         # Total missing values

#calculate percentage of missingness
miss_table <- tibble(variable = names(meta), 
                     n_missing = sapply(meta, function(x) sum(is.na(x))), 
                     pct_missing = 100 * sapply(meta, function(x) sum(is.na(x))) / nrow(meta)) %>% 
  arrange(desc(pct_missing))
print(miss_table)

  #or shorter option:
#install.packages("inspectdf")
library(inspectdf)
inspect_na(meta)

#plot 
install.packages("DataExplorer")
library(DataExplorer)
plot_missing(meta)
```

### determining type of missingness
```{r} 
#mag dit bovenste weg?
meta[is.na(meta$her2.status.ch1), ] 
meta[is.na(meta$ki67.status.ch1), ] 
meta[is.na(meta$pgr.status.ch1), ] 
meta[is.na(meta$er.status.ch1), ] 
meta[is.na(meta$chemo.treated.ch1), ] 
meta[is.na(meta$endocrine.treated.ch1), ] 
meta[is.na(meta$tumor.size.ch1), ] 
meta[is.na(meta$lymph.node.group.ch1), ] 
meta[is.na(meta$lymph.node.status.ch1), ] 

vars_to_check <- c("er.status.ch1", "pgr.status.ch1", "her2.status.ch1",
                   "tumor.size.ch1", "age.at.diagnosis.ch1", "overall.survival.days.ch1",
                   "chemo.treated.ch1", "endocrine.treated.ch1")

# Loop through variables
for(var in vars_to_check) {
  missing_col <- paste0(var, "_missing")
  meta[[missing_col]] <- is.na(meta[[var]])
  
  # Only fit GLM if some missing values exist
  if(sum(meta[[missing_col]]) > 0) {
    glm_model <- glm(
      formula = as.formula(paste(missing_col, "~ age.at.diagnosis.ch1 + tumor_size_clean + er_status + pam50")),
      data = meta,
      family = binomial
    )
    cat("\n=== Missingness for:", var, "===\n")
    print(summary(glm_model))
  } else {
    cat("\n=== Missingness for:", var, "=== No missing values ===\n")
  }
}
```
**interpretation: ** -> nog aanpassen!!
- her2.status.ch1 -> MCAR
- ki67.status.ch1 ->  MCAR (>50% missing)
- pgr.status.ch1 -> MCAR
- er.status.ch1 -> MCAR
- chemo.treated.ch1 -> MAR: pattern w NA in endocrine
- endocrine.treated.ch1 -> MAR: pattern w NA in chemo
- tumor.size.ch1 -> MCAR
- lymph.node.group.ch1 -> MAR: pattern w NA in LN status
- lymph.node.status.ch1 -> MAR: pattern w NA in LN group

## pre-processing

### factorisation
```{r}
meta <- meta %>% 
  mutate(er_status = factor(ifelse(er.status.ch1 == 1, "Positive",
                                   ifelse(er.status.ch1 == 0, "Negative", NA))),
         pgr_status = factor(ifelse(pgr.status.ch1 == 1, "Positive", 
                                    ifelse(pgr.status.ch1 == 0, "Negative", NA))),
         her2_status = factor(ifelse(her2.status.ch1 == 1, "Positive", 
                                     ifelse(her2.status.ch1 == 0, "Negative", NA))),
         ki67_status = factor(ifelse(ki67.status.ch1 == 1, "High", 
                                     ifelse(ki67.status.ch1 == 0, "Low", NA))),
         chemo = factor(ifelse(chemo.treated.ch1 == 1, "Yes", 
                               ifelse(chemo.treated.ch1 == 0, "No", NA))), 
         endocrine = factor(ifelse(endocrine.treated.ch1 == 1, "Yes", 
                                   ifelse(endocrine.treated.ch1 == 0, "No", NA))),
         nhg_ord = factor(nhg.ch1, levels = c("G1","G2","G3"), ordered = TRUE), 
         pam50 = factor(pam50.subtype.ch1))
```

### missing values, outliers & filtering
  -> dont remove NA rows & dangerous to KNN imputate when binary -> rather mention in report & dont work w these values in hypotheses

```{r}
#drop rows with NA in one or more specified columns
meta_clean <- meta %>% drop_na(er.status.ch1, her2.status.ch1, tumor.size.ch1)

#remove rows if tumor_size=0
meta_clean$tumor_size_clean <- ifelse(meta_clean$tumor.size.ch1 == 0, NA, meta_clean$tumor.size.ch1)
```

### normalisation 
```{r}
#z-score normalisation
meta_scaled <- meta_clean
meta_scaled[numeric_vars] <- lapply(meta[numeric_vars], 
                                    function(x) {(x - mean(x, na.rm = TRUE)) / sd(x, na.rm = TRUE)})

#  Convert to long format safely
meta_long_after <- meta_scaled %>%
  select(all_of(numeric_vars)) %>%
  as.data.frame() %>% 
  pivot_longer(cols = everything(),
               names_to = "variable",
               values_to = "value")

#  Plot
ggplot(meta_long_after, aes(x = value)) +
  geom_density(fill = "darkred", alpha = 0.5) +
  facet_wrap(~ variable, scales = "free") +
  theme_minimal() +
  labs(title = "Numeric Metadata Variables – AFTER Z-score Normalization",
       x = "Z-score Value", y = "Density")
```

### association tests
```{r}
# ==========================
# ASSOCIATION TESTS
# ==========================

# --- 1. Categorical vs Categorical (Chi-square) ---

# ER vs PGR
tab_er_pgr <- table(meta_clean$er.status, meta_clean$pgr.status)
cat("=== ER vs PGR ===\n")
print(chisq.test(tab_er_pgr))

# ER vs HER2
tab_er_her2 <- table(meta_clean$er_status, meta_clean$her2_status)
cat("\n=== ER vs HER2 ===\n")
print(chisq.test(tab_er_her2))

# PGR vs HER2
tab_pgr_her2 <- table(meta_clean$pgr_status, meta_clean$her2_status)
cat("\n=== PGR vs HER2 ===\n")
print(chisq.test(tab_pgr_her2))

# ER vs PAM50
tab_er_pam50 <- table(meta_clean$er_status, meta_clean$pam50)
cat("\n=== ER vs PAM50 ===\n")
print(chisq.test(tab_er_pam50))

# PAM50 vs Chemo
tab_pam50_chemo <- table(meta_clean$pam50, meta_clean$chemo)
cat("\n=== PAM50 vs Chemo ===\n")
print(chisq.test(tab_pam50_chemo))

# PAM50 vs Endocrine therapy
tab_pam50_endocrine <- table(meta_clean$pam50, meta_clean$endocrine)
cat("\n=== PAM50 vs Endocrine therapy ===\n")
print(chisq.test(tab_pam50_endocrine))

# --- 2. Numeric vs Categorical (Wilcoxon / Kruskal-Wallis) ---

# Tumor size ~ PAM50
cat("\n=== Tumor size ~ PAM50 ===\n")
print(kruskal.test(tumor_size_clean ~ pam50, data = meta_clean))

# Tumor size ~ ER
cat("\n=== Tumor size ~ ER ===\n")
print(wilcox.test(tumor_size_clean ~ er_status, data = meta_clean))

# Tumor size ~ HER2
cat("\n=== Tumor size ~ HER2 ===\n")
print(wilcox.test(tumor_size_clean ~ her2_status, data = meta_clean))

# Age ~ PAM50
cat("\n=== Age ~ PAM50 ===\n")
print(kruskal.test(age.at.diagnosis.ch1 ~ pam50, data = meta_clean))

# Age ~ ER
cat("\n=== Age ~ ER ===\n")
print(wilcox.test(age.at.diagnosis.ch1 ~ er_status, data = meta_clean))

# Age ~ Chemo
cat("\n=== Age ~ Chemo ===\n")
print(wilcox.test(age.at.diagnosis.ch1 ~ chemo, data = meta_clean))

# Survival days ~ PAM50
cat("\n=== Overall survival ~ PAM50 ===\n")
print(kruskal.test(overall.survival.days.ch1 ~ pam50, data = meta_clean))

# --- 3. Numeric vs Numeric (Spearman correlation) ---

cat("\n=== Correlation: Age vs Tumor size ===\n")
print(cor.test(meta$age.at.diagnosis.ch1, meta_clean$tumor_size_clean, method = "spearman"))

cat("\n=== Correlation: Tumor size vs Survival days ===\n")
print(cor.test(meta$tumor_size_clean, meta_clean$overall.survival.days.ch1, method = "spearman"))

cat("\n=== Correlation: Age vs Survival days ===\n")
print(cor.test(meta$age.at.diagnosis.ch1, meta_clean$overall.survival.days.ch1, method = "spearman"))

```

# PART 2: FORMULATION OF 2 HYPOTHESES

## univariate research question

RQ1: Is there a difference in tumor size between the ER-positive and ER-negative groups?

*hypothesis: *
•	Null hypothesis (H0): There is no difference in tumor size between the ER-positive and ER-negative group.
•	Alternative hypothesis (H1): There is a difference in tumor size between the ER-positive and ER-negative group.

```{r}
meta_uni <- meta_clean %>% 
  filter(!is.na(tumor.size.ch1), !is.na(pam50.subtype.ch1))

#log-transformation tumor size
meta_log <- meta_uni 
meta_log$log_tumor_size <- log(meta_log$tumor_size_clean)
meta_long_log <- meta_log %>% 
  select(log_tumor_size) %>% 
  as.data.frame() %>% 
  pivot_longer(cols = everything(), names_to = "variable", values_to = "value")
ggplot(meta_long_log, aes(x = value)) + 
  geom_histogram(fill = "darkred", alpha = 0.5, color = "black") + 
  facet_wrap(~ variable, scales = "free") + 
  theme_minimal() + 
  labs(title = "Log-transformatie van Tumor Size", x = "Z-score Value", y = "Density")

#t-test
t.test(tumor_size_clean ~ er_status, data = meta_log)

#visualisation
ggplot(meta_log, aes(x = er_status, y = log_tumor_size)) + 
  geom_boxplot() + 
  theme_minimal() + 
  labs(title = "Log-transformed Tumor Size by ER Status", x = "ER Status", y = "Log-transformed Tumor Size") 

```
**conclusion: **
ER negative tumors have a significantly higher mean log tumor size compared to ER positive tumors (p < 0.001  ; 95% CI: [1.697980 ; 5.791482]).  Therefore, the null hypothesis can be rejected. 


## multivariate research question

RQ2: Does the PAM50 subtype predict overall survival, even after adjusting for clinical covariates?
- Dependent: Overall survival
- Predictors: PAM50 + age + tumor size + lymph node status

*hypothesis: *
•	Null hypothesis (H0): Overall survival does not differ among the PAM50 molecular subtypes after adjusting for clinical covariates (age, tumor size, lymph node status).
•	Alternative hypothesis (H1): Overall survival differs among the PAM50 molecular subtypes after adjusting for clinical covariates (age, tumor size, lymph node status).

```{r}
library(survival) 
library(survminer)

summary(meta$overall.survival.days.ch1) 
summary(meta$overall.survival.event.ch1) 

#data set voorbereiden
meta_surv <- meta_clean %>% 
  filter(!is.na(overall.survival.days.ch1), 
         !is.na(overall.survival.event.ch1), 
         !is.na(pam50.subtype.ch1), 
         !is.na(tumor.size.ch1), 
         !is.na(age.at.diagnosis.ch1), 
         !is.na(lymph.node.status.ch1)) 
meta_surv$pam50.subtype.ch1 <- relevel(factor(meta_surv$pam50.subtype.ch1), ref = "Normal")

#survival object 
surv_obj <- Surv(time = meta_surv$overall.survival.days.ch1, 
                 event = meta_surv$overall.survival.event.ch1) 

#unadjusted kaplan-meier curve
fit_km <- survfit(surv_obj ~ pam50.subtype.ch1, data = meta_surv)
ggsurvplot(fit_km, 
           data = meta_surv, 
           risk.table = TRUE, 
           risk.table.col = "strata",
           pval = TRUE, 
           ggtheme = theme_minimal(), 
           title = "Unadjusted Kaplan-Meier Survival by PAM50 Subtype",
           legend.title = "PAM50 Subtype",
           legend.labs = c("Basal", "Her2", "LumA", "LumB", "Normal")) 
```

*statistical test: cox model & visualisation: kaplan-meier curve*
```{r}
#cox h model  
cox_model <- coxph(surv_obj ~ pam50.subtype.ch1 + age.at.diagnosis.ch1 + tumor.size.ch1 + lymph.node.status.ch1, data = meta_surv)
summary(cox_model) 

#assumptions check 
cox.zph(cox_model) 
plot(cox.zph(cox_model))

# adjusted survival via cox model
ggadjustedcurves(cox_model, 
                 data = meta_surv, 
                 variable = "pam50.subtype.ch1",
                 ref = "Normal",
                 ggtheme = theme_minimal(), 
                 title = "Adjusted Kaplan-Meier Survival by PAM50 Subtype",
                 legend.title = "PAM50 Subtype",
                 legend.labs = c("Basal", "Her2", "LumA", "LumB", "Normal"))
```
**conclusion: **
The PAM50 subtypes ‘Basal’ and ‘Her2’ have a significantly higher hazard of death compared to the ‘Normal’ PAM50 subtype, respectively 5.12 times higher (p=2.31e-06 ; 95% CI: [2.60, 10.085]) and 2.5 times higher (p=0.00959 ; 95% CI: [1.25,4.92]). There is no strong evidence of different hazard for the LumA and LumB subtypes (p > 0.05).


# PART 3: MACHINE LEARNING
(see python)

```{r}

```



